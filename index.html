<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ajustes - Panel Logística</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root {
  --bg-dark: #111827;
  --bg-medium: #1F2937;
  --text-light: #F9FAFB;
  --text-medium: #9CA3AF;
  --accent-blue: #3B82F6;
  --accent-green: #10B981;
  --accent-red: #EF4444;
  --font-family: 'Poppins', sans-serif;
  --border-radius-md: 16px;
  --border-radius-sm: 10px;
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
}
html, body {
  margin: 0;
  height: 100%;
  font-family: var(--font-family);
  color: var(--text-light);
  background-color: var(--bg-dark);
  background-image: 
    radial-gradient(at 47% 33%, hsl(225, 39%, 30%) 0, transparent 59%), 
    radial-gradient(at 82% 65%, hsl(253, 16%, 7%) 0, transparent 55%);
}

/* =================== ESTILOS GENERALES Y SPLASH SCREEN =================== */
.pantalla {
  display: none;
  width: 100%;
  min-height: 100vh;
  padding: 20px;
  transition: opacity 0.5s ease-out;
  box-sizing: border-box;
}
.pantalla.activa { 
  display: flex; 
  flex-direction: column; 
  align-items: center;
  justify-content: center;
}
#splashScreen {
  position: fixed;
  top: 0;
  left: 0;
  z-index: 9999;
}
.brand-title {
  font-family: 'Times New Roman', Times, serif;
  color: white;
  font-size: clamp(40px, 3vw, 28px);
  font-weight: normal;
  text-align: center;
  width: 100%;
  letter-spacing: 2px;
  margin-top: 10px;
  margin-bottom: 5px;
  padding: 0;
}
#splashScreen .brand-title {
    margin-bottom: 20px;
}
.splash-content {
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}
.splash-logo-container {
  border-radius: 25px;
  margin: 20px 0;
  padding: 15px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}
.splash-logo {
  width: 150px;
  height: auto;
  display: block;
  border-radius: 15px;
}
.splash-loading {
  font-size: 1.2rem;
  color: var(--text-medium);
  letter-spacing: 2px;
}
.splash-loading .dot {
  animation: blink-dot 1.4s infinite;
  opacity: 0;
}
.splash-loading .dot:nth-child(2) { animation-delay: 0.2s; }
.splash-loading .dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink-dot { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

/* =================== ESTILOS PANELES DE CONTENIDO =================== */
h1 {
  text-align: center;
  margin-top: 0;
  margin-bottom: 30px;
  font-size: clamp(28px, 5vw, 42px);
}
.panel-contenido {
  width: 100%;
  max-width: 600px;
  padding: 30px;
  border-radius: var(--border-radius-md);
  background: rgba(31, 41, 55, 0.7);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.15);
}
.form-group { margin-bottom: 20px; }
.form-group label {
  display: block;
  margin-bottom: 8px;
  color: var(--text-medium);
  font-weight: 600;
}
.form-group input {
  width: 100%;
  padding: 12px;
  border-radius: var(--border-radius-sm);
  color: var(--text-light);
  font-size: 16px;
  font-family: var(--font-family);
  background: rgba(17, 24, 39, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-sizing: border-box;
}
.form-group input:focus {
  outline: none;
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
}
.btn {
  background: rgba(59, 130, 246, 0.25);
  color: var(--text-light);
  border: 1px solid rgba(255, 255, 255, 0.15);
  padding: 14px 28px;
  border-radius: var(--border-radius-sm);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background .2s ease, transform .2s ease;
  width: 100%;
  margin-top: 10px;
}
.btn:hover { background: rgba(59, 130, 246, 0.4); transform: translateY(-2px); }
.btn.btn-save { background-color: rgba(16, 185, 129, 0.3); }
.btn.btn-save:hover { background-color: rgba(16, 185, 129, 0.5); }
.btn.btn-back { background-color: rgba(239, 68, 68, 0.3); }
.btn.btn-back:hover { background-color: rgba(239, 68, 68, 0.5); }

/* =================== ESTILOS PARA MODALES =================== */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.modal.visible { visibility: visible; opacity: 1; }
.modal-content {
  padding: 30px;
  text-align: center;
  width: 90%;
  max-width: 500px;
  box-shadow: var(--shadow-lg);
  border-radius: var(--border-radius-md);
  background: rgba(31, 41, 55, 0.7);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.15);
}
.modal-content h3 { margin-top: 0; font-size: 22px; margin-bottom: 25px; }
.modal-generic-message {
  font-size: 16px;
  color: var(--text-medium);
  margin-bottom: 25px;
  line-height: 1.6;
}
.modal-prompt-input {
  width: 100%;
  padding: 12px;
  border-radius: var(--border-radius-sm);
  color: var(--text-light);
  font-size: 16px;
  font-family: var(--font-family);
  background: rgba(17, 24, 39, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.modal-prompt-input:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
}
.modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 15px;
  margin-top: 20px;
}
</style>
</head>
<body>

<section id="splashScreen" class="pantalla activa">
    <div class="splash-content">
        <p class="brand-title">CORNING</p>
        <div class="splash-logo-container">
             <img src="iconolog-512.PNG" alt="Logo" class="splash-logo">
        </div>
        <p class="splash-loading">Cargando<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></p>
    </div>
</section>

<section id="pantallaPrincipal" class="pantalla">
    <div class="panel-contenido">
        <p class="brand-title">CORNING</p>
        <h1>AJUSTES</h1>
        <button id="btnConfig" class="btn">CONFIGURACIÓN</button>
    </div>
</section>

<section id="panelAjustes" class="pantalla">
    <div class="panel-contenido">
        <p class="brand-title">CORNING</p>
        <h1>🔑 Administración</h1>
        <form id="formContraseñas"></form>
        <button id="btnGuardar" class="btn btn-save">Guardar Cambios</button>
        <button id="btnVolver" class="btn btn-back">Volver</button>
    </div>
</section>

<div id="modalAlert" class="modal">
    <div class="modal-content">
        <h3 id="modalAlertTitle">Notificación</h3>
        <p id="modalAlertMessage" class="modal-generic-message"></p>
        <div class="modal-buttons" style="justify-content: center;">
            <button id="modalAlertOk" class="btn">OK</button>
        </div>
    </div>
</div>
<div id="modalPrompt" class="modal">
    <div class="modal-content">
        <h3 id="modalPromptTitle">Introducir Datos</h3>
        <p id="modalPromptMessage" class="modal-generic-message"></p>
        <input type="password" id="modalPromptInput" class="modal-prompt-input" autocomplete="off" />
        <div class="modal-buttons">
            <button id="modalPromptCancel" class="btn btn-back">Cancelar</button>
            <button id="modalPromptOk" class="btn">Aceptar</button>
        </div>
    </div>
</div>


<script>
// --- Configuración de Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyDahnSPvBNTYot00JCn5CBjggAYFVGhbjE",
  authDomain: "panel-logistica-simple.firebaseapp.com",
  databaseURL: "https://panel-logistica-simple-default-rtdb.firebaseio.com",
  projectId: "panel-logistica-simple",
  storageBucket: "panel-logistica-simple.appspot.com",
  messagingSenderId: "528779971851",
  appId: "1:528779971851:web:90241469a69be3a5a4e60e"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ======================= MODALES PERSONALIZADOS =======================
const customAlert = (message, title = "Notificación") => {
    return new Promise(resolve => {
        const modal = document.getElementById('modalAlert');
        document.getElementById('modalAlertTitle').textContent = title;
        document.getElementById('modalAlertMessage').textContent = message;
        modal.classList.add('visible');
        const okButton = document.getElementById('modalAlertOk');
        const closeListener = () => {
            modal.classList.remove('visible');
            okButton.removeEventListener('click', closeListener);
            resolve();
        };
        okButton.addEventListener('click', closeListener);
    });
};

const customPrompt = (message, title = "Autenticación Requerida") => {
    return new Promise(resolve => {
        const modal = document.getElementById('modalPrompt');
        const input = document.getElementById('modalPromptInput');
        document.getElementById('modalPromptTitle').textContent = title;
        document.getElementById('modalPromptMessage').textContent = message;
        input.value = '';
        modal.classList.add('visible');
        setTimeout(() => input.focus(), 50);
        const okButton = document.getElementById('modalPromptOk');
        const cancelButton = document.getElementById('modalPromptCancel');
        const resolveListener = (value) => {
            modal.classList.remove('visible');
            okButton.removeEventListener('click', okListener);
            cancelButton.removeEventListener('click', cancelListener);
            input.removeEventListener('keydown', enterListener);
            resolve(value);
        };
        const okListener = () => resolveListener(input.value);
        const cancelListener = () => resolveListener(null);
        const enterListener = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                okListener();
            }
        };
        okButton.addEventListener('click', okListener);
        cancelButton.addEventListener('click', cancelListener);
        input.addEventListener('keydown', enterListener);
    });
};

// --- Lógica de la página ---
function activarPantalla(id){
    document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
    document.getElementById(id).classList.add('activa');
}

window.addEventListener('load', () => {
    // 1. Iniciar la lógica de la pantalla de carga
    setTimeout(() => {
        const splash = document.getElementById('splashScreen');
        splash.style.opacity = '0';
        splash.addEventListener('transitionend', () => {
            splash.remove(); // Eliminar la splash screen del DOM
            activarPantalla('pantallaPrincipal'); // Mostrar la pantalla principal
        }, { once: true });
    }, 1500);
});

document.getElementById('btnConfig').addEventListener('click', () => {
    firebase.auth().signInAnonymously()
        .then(autenticarAdmin)
        .catch(async (error) => {
            console.error("Error de autenticación anónima:", error);
            await customAlert('Error al conectar. Por favor, recarga la página.', 'Error de Conexión');
        });
});

document.getElementById('btnVolver').addEventListener('click', () => {
    activarPantalla('pantallaPrincipal');
});

async function autenticarAdmin() {
    try {
        const passRef = database.ref('config/passwords/SUPERVISOR');
        const snapshot = await passRef.once('value');
        const passAdmin = snapshot.val();

        if (!passAdmin) {
            await customAlert('Error: No se pudo obtener la contraseña de SUPERVISOR. Asegúrate de haber iniciado la app principal al menos una vez.', 'Error de Configuración');
            return;
        }

        const inputPass = await customPrompt('Por favor, introduce la contraseña de SUPERVISOR para continuar:');

        if (inputPass === null) return; // El usuario canceló

        if (inputPass === passAdmin) {
            activarPantalla('panelAjustes');
            cargarContraseñasActuales();
        } else {
            await customAlert('Contraseña incorrecta. Inténtalo de nuevo.', 'Acceso Denegado');
        }
    } catch (error) {
        console.error("Error al autenticar:", error);
        await customAlert('Hubo un error al verificar los permisos.', 'Error');
    }
}

async function cargarContraseñasActuales() {
    const form = document.getElementById('formContraseñas');
    form.innerHTML = '';
    const passwordsRef = database.ref('config/passwords');
    const snapshot = await passwordsRef.once('value');
    const passwords = snapshot.val();
    const orderedKeys = Object.keys(passwords).sort();

    orderedKeys.forEach(key => {
        const value = passwords[key];
        const formGroup = document.createElement('div');
        formGroup.className = 'form-group';
        formGroup.innerHTML = `
            <label for="pass_${key}">${key.replace(/_/g, ' ')}</label>
            <input type="text" id="pass_${key}" value="${value}" data-key="${key}">
        `;
        form.appendChild(formGroup);
    });
}

document.getElementById('btnGuardar').addEventListener('click', async () => {
    const inputs = document.querySelectorAll('#formContraseñas input');
    const nuevasContraseñas = {};
    inputs.forEach(input => nuevasContraseñas[input.dataset.key] = input.value);

    try {
        await database.ref('config/passwords').set(nuevasContraseñas);
        await customAlert('¡Contraseñas actualizadas con éxito!', 'Guardado');
    } catch (error) {
        console.error("Error al guardar las contraseñas:", error);
        await customAlert('Error al guardar. Revisa la consola para más detalles.', 'Error');
    }
});
</script>

</body>
</html>